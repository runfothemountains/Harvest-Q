<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Harvest Q – Stage 3 (Beta)</title>
  <meta name="description" content="Harvest Q – Connecting Farmers, Consumers & Communities through Trade, Grants, and AI" />
  <meta name="ibm-watsonx" content="granite-13b-code, watsonx.ai, AI pricing, barter matching">

  <!-- PWA & icons -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0f766e" />
  <link rel="icon" href="./logo.png" />
  <link rel="apple-touch-icon" href="./logo.png" />

  <!-- CSS (versioned for cache-busting) -->
  <link rel="stylesheet" href="./css/style.css?v=3" />

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Service worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then(reg => {
        if (reg.waiting) {
          reg.waiting.postMessage('SKIP_WAITING');
        }
      }).catch(() => {});
    }
  </script>
</head>
<body>
  <header class="hq-header">
    <div class="container">
      <div class="brand">
        <img src="./logo.png" alt="Harvest Q logo" onerror="this.style.display='none'">
        <div>
          <h1>Harvest Q <span class="beta">BETA</span></h1>
          <p id="header-sub">Connecting farms, communities, and AI for sustainable food systems.</p>
        </div>
      </div>

      <!-- IBM watsonx.ai Badge -->
      <div class="ibm-badge">
        <img src="https://img.shields.io/badge/Powered_by-watsonx.ai-0D4B8A?style=flat&logo=ibm" alt="IBM watsonx.ai">
      </div>

      <div class="lang-area">
        <label for="langSelect" class="muted">Language / Region</label>
        <select id="langSelect">
          <!-- Real language toggle -->
          <option value="en">English (Global)</option>
          <option value="hi">हिन्दी (India)</option>

          <!-- Region presets that still use English UI (value="en") -->
          <option value="en">United States</option>
          <option value="en">Canada</option>
          <option value="en">Brazil</option>
          <option value="en">Nigeria</option>
          <option value="en">Kenya</option>
          <option value="en">Ethiopia</option>
          <option value="en">France</option>
          <option value="en">Germany</option>
          <option value="en">Spain</option>
          <option value="en">Italy</option>
          <option value="en">Russia</option>
          <option value="en">China</option>
          <option value="en">Guatemala</option>
          <option value="en">Turkey</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Tabs -->
    <nav id="tabs" class="tabs" role="tablist" aria-label="Main sections">
      <!-- data-panel values match panel IDs without the "panel-" prefix -->
      <button class="tab" data-panel="home" role="tab" aria-selected="true" aria-controls="panel-home">Home</button>
      <button class="tab" data-panel="farmers" role="tab" aria-selected="false" aria-controls="panel-farmers">Farmers</button>
      <button class="tab" data-panel="consumers" role="tab" aria-selected="false" aria-controls="panel-consumers">Consumers</button>
      <button class="tab" data-panel="laws" role="tab" aria-selected="false" aria-controls="panel-laws">Laws</button>
      <button class="tab" data-panel="medical" role="tab" aria-selected="false" aria-controls="panel-medical">Medical</button>
      <button class="tab" data-panel="trade" role="tab" aria-selected="false" aria-controls="panel-trade">Trade</button>
      <button class="tab" data-panel="ai" role="tab" aria-selected="false" aria-controls="panel-ai">AI</button>
      <button class="tab" data-panel="grants" role="tab" aria-selected="false" aria-controls="panel-grants">Grants</button>
    </nav>

    <!-- HOME -->
    <section id="panel-home" class="panel" role="tabpanel" aria-labelledby="tab-home">
      <div class="grid two-col">
        <div>
          <div class="card">
            <h3>Welcome to Harvest Q</h3>
            <p>
              Empowering farmers, consumers, and local organizations to trade, connect, and grow sustainably.
              Choose your country below to explore markets and community initiatives.
            </p>
          </div>

          <div class="card">
            <h3 id="home-what-title">What this beta shows</h3>
            <p id="home-what-content">
              Country/state/city filters • Farmers & Consumers • Map markers • PWA scaffold.
            </p>
          </div>

          <div class="card">
            <h3>Quick Filters</h3>
            <div class="toolbar">
              <label>Country
                <select id="countrySelect">
                  <option>US</option><option>India</option><option>Nigeria</option><option>Russia</option>
                  <option>Canada</option><option>China</option><option>Germany</option><option>Brazil</option>
                  <option>Kenya</option><option>Ethiopia</option><option>Turkey</option><option>France</option>
                  <option>Spain</option><option>Italy</option><option>Guatemala</option>
                </select>
              </label>
              <label>State/Region
                <select id="stateSelect"></select>
              </label>
              <label id="cityLabel">City
                <select id="citySelect"><option value="">All Cities</option></select>
              </label>
              <button class="btn" id="refreshBtn">Refresh</button>
            </div>
          </div>
        </div>
        <div>
          <div class="card warning" id="home-warning">
            <strong>Note:</strong> This beta shows community-driven features for the IBM Hackathon. Data is demo-only.
          </div>
        </div>
      </div>
    </section>

    <!-- FARMERS -->
    <section id="panel-farmers" class="panel" role="tabpanel" aria-labelledby="tab-farmers" hidden>
      <div class="toolbar">
        <input id="farmerSearch" placeholder="Search farmers or products..." />
        <select id="modeFilter">
          <option value="all">All</option>
          <option value="sale">For Sale</option>
          <option value="trade">Trade</option>
          <option value="both">Both</option>
        </select>
        <select id="sortBy">
          <option value="name">Name</option>
          <option value="priceAsc">Price (Low to High)</option>
        </select>
        <button class="btn" id="postOpenBtn">Post a Listing</button>
      </div>
      <div id="farmerGrid" class="grid"></div>

      <div id="mapArea" class="card" style="margin-top:12px">
        <h4>Market Map</h4>
        <div id="map-loading" class="spinner">Loading map...</div>
        <div
          id="map"
          style="height:360px;border-radius:8px;display:none;"
          aria-label="Interactive farmer location map">
        </div>
        <div id="map-legend" class="legend"></div>
      </div>
    </section>

    <!-- CONSUMERS -->
    <section id="panel-consumers" class="panel" role="tabpanel" aria-labelledby="tab-consumers" hidden>
      <div class="toolbar">
        <input id="consumerSearch" placeholder="Search buyers or requests..." />
      </div>
      <div id="consumerGrid" class="grid"></div>

      <div id="consumerMapArea" class="card" style="margin-top:12px">
        <h4>Consumer Map</h4>
        <div id="consumer-map-loading" class="spinner">Loading map...</div>
        <div
          id="consumer-map"
          style="height:360px;border-radius:8px;display:none;"
          aria-label="Interactive consumer location map">
        </div>
        <div id="consumer-map-legend" class="legend"></div>
      </div>
    </section>

    <!-- LAWS -->
    <section id="panel-laws" class="panel" role="tabpanel" aria-labelledby="tab-laws" hidden>
      <div class="card">
        <h3>Key Agricultural and Consumer Laws</h3>
        <p>Below are essential laws that protect farmers and consumers in each participating country.</p>
      </div>

      <!-- JS will re-render this grid via LAW_INFO; static content is fallback -->
      <div id="lawGrid" class="grid">
        <div class="card"><h4>United States</h4><ul><li>Farm Bill — Crop insurance & conservation.</li><li>FSMA — Produce safety standards.</li><li>Fair Packaging & Labeling Act.</li></ul></div>
        <div class="card"><h4>India</h4><ul><li>Essential Commodities Act.</li><li>Consumer Protection Act.</li><li>PM-KISAN farmer income support.</li></ul></div>
        <div class="card"><h4>Nigeria</h4><ul><li>Agricultural Credit Guarantee Scheme.</li><li>Consumer Protection Council Act.</li><li>Land Use Act — Farm ownership rights.</li></ul></div>
        <div class="card"><h4>Brazil</h4><ul><li>Agricultural Policy Law.</li><li>Consumer Defense Code.</li><li>Environmental Crimes Law.</li></ul></div>
        <div class="card"><h4>Canada</h4><ul><li>Safe Food for Canadians Act.</li><li>Agricultural Products Marketing Act.</li><li>Competition Act.</li></ul></div>
        <div class="card"><h4>France</h4><ul><li>Common Agricultural Policy (EU).</li><li>Consumer Code.</li><li>Farm Transition Law.</li></ul></div>
        <div class="card"><h4>Kenya</h4><ul><li>Agriculture & Food Authority Act.</li><li>Weights and Measures Act.</li><li>Consumer Protection Act (2012).</li></ul></div>
        <div class="card"><h4>Ethiopia</h4><ul><li>Cooperative Societies Proclamation.</li><li>Seed Law.</li><li>Trade & Consumer Protection Proclamation.</li></ul></div>
        <div class="card"><h4>China</h4><ul><li>Rural Land Contract Law.</li><li>Food Safety Law.</li><li>Farmers’ Cooperatives Law.</li></ul></div>
        <div class="card"><h4>Spain</h4><ul><li>Agri-Food Chain Law.</li><li>Organic Production Regulation.</li><li>Consumer Rights Law.</li></ul></div>
      </div>

      <p id="laws-disclaimer" class="footer-note">
        Provided for education only. Always verify local laws before trading or exporting.
      </p>
    </section>

    <!-- MEDICAL -->
    <section id="panel-medical" class="panel" role="tabpanel" aria-labelledby="tab-medical" hidden>
      <div class="card">
        <h3>Farmer Health & Safety</h3>
        <p>Healthy farmers sustain healthy communities. Harvest Q encourages good agricultural and medical practices.</p>
        <ul class="muted">
          <li>Always use clean water when washing or irrigating produce.</li>
          <li>Wear gloves and protective gear when using fertilizers or pesticides.</li>
          <li>Stay hydrated and take shade breaks during long harvest days.</li>
          <li>Visit your local clinic for annual health checks and vaccinations.</li>
        </ul>
      </div>

      <!-- JS will populate MED_TIPS into this grid -->
      <div id="medGrid" class="grid"></div>
    </section>

    <!-- TRADE / BARTER -->
    <section id="panel-trade" class="panel" role="tabpanel" aria-labelledby="tab-trade" hidden>
      <div class="card">
        <h3>Community Barter Exchange</h3>
        <p>Many members exchange goods or services instead of cash. Here are current examples from different countries.</p>
      </div>

      <div class="grid">
        <div class="card"><h4>Farm-to-Farm</h4><ul><li>Tomatoes to Onions</li><li>Maize to Rice</li><li>Groundnuts to Palm oil</li><li>Yams to Beans</li></ul></div>
        <div class="card"><h4>Value-Added</h4><ul><li>Honey to Fresh fruits</li><li>Soap to Cornmeal</li><li>Shea butter to Cocoa beans</li></ul></div>
        <div class="card"><h4>Livestock & Feed</h4><ul><li>Goat milk to Poultry feed</li><li>Eggs to Cassava chips</li><li>Fish fingerlings to Maize bran</li></ul></div>
        <div class="card"><h4>Tools & Labor</h4><ul><li>Tractor hours to Harvest help</li><li>Fertilizer to Irrigation repair</li><li>Crates to Transport support</li></ul></div>
        <div class="card"><h4>Community Trades</h4><ul><li>Solar lamps to Produce baskets</li><li>Seeds to School supplies</li><li>Vegetables to Meals for elderly</li></ul></div>
      </div>

      <p id="trade-disclaimer" class="footer-note">
        Harvest Q promotes fair barter to reduce waste and build community resilience.
      </p>
    </section>

    <!-- AI / HOOK LOOKUP -->
    <section id="panel-ai" class="panel" role="tabpanel" aria-labelledby="tab-ai" hidden>
      <div class="card">
        <h3>AI Hook Lookup & Agent Playground</h3>
        <p>
          Use this space to experiment with IBM watsonx agents, price helpers, and barter matching
          using the same filters as the Farmers & Consumers tabs.
        </p>
        <div class="flex" style="gap:10px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" id="connectAgentBtn">Connect IBM Agent</button>
          <span id="agentStatus">Offline – using local demo logic.</span>
        </div>

        <!-- IBM watsonx.ai Note -->
        <div class="watsonx-note muted" style="margin-top:8px">
          <strong>IBM watsonx.ai Ready</strong>: Price & barter tools will use <code>granite-13b-code</code> model.
        </div>
      </div>

      <div class="grid">
        <!-- AI Price Helper -->
        <div class="card">
          <h4>AI Price Helper</h4>
          <p class="muted">Ask AI for a suggested price band for a crop in your selected country.</p>
          <div class="toolbar" style="margin-top:8px">
            <label>Crop
              <select id="aiCrop">
                <option value="">Select crop…</option>
                <option>Tomatoes</option>
                <option>Maize</option>
                <option>Onions</option>
                <option>Rice</option>
                <option>Wheat</option>
              </select>
            </label>
            <label>Quantity
              <input id="aiQty" placeholder="e.g. 40 lb or 20 kg" />
            </label>
          </div>
          <button class="btn" id="aiPriceBtn" style="margin-top:8px">Ask AI</button>
          <div id="aiPriceOut" class="ai-result">Enter crop and quantity to get AI pricing.</div>
        </div>

        <!-- AI Barter Match -->
        <div class="card">
          <h4>AI Barter Match</h4>
          <p class="muted">Describe what you want to trade and receive. AI will search demo barter partners.</p>
          <label for="aiWant">What are you offering / seeking?</label>
          <textarea id="aiWant" placeholder="e.g. Swap 3 crates of tomatoes for onions or transport help" style="width:100%;min-height:80px;margin-top:4px"></textarea>
          <button class="btn" id="aiMatchBtn" style="margin-top:8px">Find Match</button>
          <pre id="aiMatchOut" class="ai-result">Describe your trade to find matches.</pre>
        </div>
      </div>

      <!-- Agent tools playground / trace -->
      <div class="card" style="margin-top:12px">
        <div class="toolbar">
          <label>Tool
            <select id="toolSelect">
              <option value="priceBands">Price bands (demo)</option>
              <option value="findSuppliers">Find suppliers</option>
              <option value="scoreMatch">Score match</option>
              <option value="planRoute">Plan route</option>
            </select>
          </label>
          <button class="btn secondary" id="runToolBtn">Run Tool (debug)</button>
          <span class="api-badge offline">API demo mode</span>
        </div>
        <div id="agentTrace" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- GRANTS -->
    <section id="panel-grants" class="panel" role="tabpanel" aria-labelledby="tab-grants" hidden>
      <div class="card">
        <h3>Harvest Grant Program</h3>
        <p>We’re launching a <strong>$500 Micro-Grant</strong> to support farmers, consumers, and organizations fighting hunger and food waste.</p>
        <h4>Who Can Apply?</h4>
        <ul class="muted">
          <li>Farmers improving sustainability or food access.</li>
          <li>Consumers promoting local produce or community gardens.</li>
          <li>Organizations supporting the elderly, homeless, or low-income families.</li>
        </ul>
        <div class="flex" style="gap:8px;margin-top:10px">
          <a class="btn" href="mailto:grants@harvestq.org?subject=Harvest%20Grant%20Application">Apply Now</a>
          <a class="btn secondary" href="#">Read Program FAQ</a>
        </div>
        <p class="footer-note">Applications open soon. Stay tuned for official announcements.</p>
      </div>
    </section>

    <!-- POST LISTING MODAL -->
    <div id="postModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="postTitle" hidden>
      <div class="modal-content card">
        <h3 id="postTitle">Post a Listing</h3>
        <form id="postForm">
          <div class="field">
            <label for="pfFarm">Farm name</label>
            <input id="pfFarm" type="text" placeholder="e.g. Green Valley Farm" required />
          </div>
          <div class="field">
            <label for="pfProduct">Product</label>
            <input id="pfProduct" type="text" placeholder="e.g. Tomatoes" required />
          </div>
          <div class="field">
            <label for="pfQty">Quantity</label>
            <input id="pfQty" type="text" placeholder="e.g. 40 lb or 20 kg" />
            <div id="errQty" class="field-error"></div>
          </div>
          <div class="field">
            <label for="pfPrice">Price per unit</label>
            <input id="pfPrice" type="text" placeholder="e.g. 2.50" />
            <div id="errPrice" class="field-error"></div>
          </div>
          <div class="field">
            <label for="pfMode">Mode</label>
            <select id="pfMode">
              <option value="sale">For Sale</option>
              <option value="trade">Trade</option>
              <option value="both">Both</option>
            </select>
          </div>
          <div id="postErrors" class="field-error" style="margin-top:4px"></div>
          <div class="actions" style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
            <button type="button" class="btn secondary" id="postCancel">Cancel</button>
            <button type="submit" class="btn">Save Listing</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ERROR OVERLAY -->
    <div id="hq-error" class="error-overlay" hidden>
      <div class="error-box card">
        <h3>Error</h3>
        <p id="hq-error-text">Something went wrong.</p>
        <button type="button" class="btn" onclick="document.getElementById('hq-error').hidden=true">
          Close
        </button>
      </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer-note" id="footer-text">
      © Harvest Q — Connecting Farms & Communities | <span id="footer-date"></span>
    </footer>
  </main>

  <script src="./js/app.js" defer></script>

  <!-- Live Footer Date -->
  <script>
    document.getElementById('footer-date').textContent =
      new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  </script>
</body>
</html>
