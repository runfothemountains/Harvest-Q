<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Harvest Q – Stage 2 (Beta)</title>
  <meta name="description" content="Harvest Q – Markets, map, and AI price suggestions (Stage 2)" />

  <!-- PWA & icons (relative paths for GH Pages / Vercel) -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0f766e" />
  <link rel="icon" href="./logo.png" />
  <link rel="apple-touch-icon" href="./logo.png" />

  <link rel="stylesheet" href="./css/style.css" />

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // register relative service worker so it works on GitHub Pages subpaths
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>
</head>
<body>
  <!-- Compare banner: update URLs after deploy -->
  <div class="compare-banner">
    <strong>Compare:</strong>
    <a id="cmp-stage1" href="#">Stage 1</a> |
    <a id="cmp-stage2" href="#">Stage 2</a>
  </div>

  <header class="hq-header">
    <div class="container">
      <div class="brand">
        <img src="./logo.png" alt="Harvest Q logo" onerror="this.style.display='none'">
        <div>
          <h1>Harvest Q <span class="beta">BETA</span></h1>
          <p id="header-sub"></p>
        </div>
      </div>
      <div class="lang-area">
        <label for="langSelect" class="muted">Language</label>
        <select id="langSelect">
          <option value="en">English</option>
          <option value="hi">हिन्दी (Hindi)</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <nav id="tabs" class="tabs" role="tablist" aria-label="Main sections"></nav>

    <section id="panel-home" role="tabpanel" hidden>
      <div class="grid two-col">
        <div>
          <div class="card">
            <h3 id="home-what-title"></h3>
            <p id="home-what-content"></p>
          </div>
          <div class="card">
            <h3>Values</h3>
            <p id="home-phil-content"></p>
            <div class="blockquote" id="home-phil-quote"></div>
          </div>
        </div>
        <div>
          <div class="card">
            <h3>Quick Filters</h3>
            <div class="toolbar">
              <label>Country
                <select id="countrySelect"></select>
              </label>
              <label>State/Region
                <select id="stateSelect"></select>
              </label>
              <label id="cityLabel">City
                <select id="citySelect"><option value="">All Cities</option></select>
              </label>
              <button class="btn" id="refreshBtn">Refresh</button>
            </div>
            <p class="footer-note" id="home-switch-note"></p>
          </div>
          <div class="card warning" id="home-warning"></div>
        </div>
      </div>
    </section>

    <section id="panel-farmers" role="tabpanel" hidden>
      <div class="toolbar">
        <input id="farmerSearch" placeholder="" />
        <select id="modeFilter">
          <option value="all"></option>
          <option value="sale"></option>
          <option value="trade"></option>
          <option value="both"></option>
        </select>
        <select id="sortBy">
          <option value="name"></option>
          <option value="priceAsc"></option>
        </select>
        <button class="btn" id="postOpenBtn">Post a Listing</button>
      </div>
      <div id="farmerGrid" class="grid"></div>
      <div id="mapArea" class="card" style="margin-top:12px">
        <h4>Market Map</h4>
        <div id="map" style="height:360px;border-radius:8px;"></div>
        <div id="map-legend" class="legend"></div>
      </div>
    </section>

    <section id="panel-consumers" role="tabpanel" hidden>
      <div class="toolbar"><input id="consumerSearch" placeholder="" /></div>
      <div id="consumerGrid" class="grid"></div>
    </section>

    <section id="panel-laws" role="tabpanel" hidden>
      <div id="lawGrid" class="grid"></div>
      <p class="muted" id="laws-disclaimer"></p>
    </section>

    <section id="panel-ai" role="tabpanel" hidden>
      <div class="card">
        <h3 id="ai-price-title"></h3>
        <div class="toolbar">
          <input id="aiCrop" list="cropList" placeholder="" />
          <input id="aiQty" placeholder="" />
          <button class="btn" id="aiPriceBtn"><span id="ai-price-btn-text"></span></button>
        </div>
        <pre id="aiPriceOut"></pre>
      </div>

      <div class="card">
        <h3 id="ai-match-title"></h3>
        <div class="toolbar">
          <input id="aiWant" placeholder="" />
          <button class="btn" id="aiMatchBtn"><span id="ai-match-btn-text"></span></button>
        </div>
        <pre id="aiMatchOut"></pre>
      </div>
    </section>

    <footer class="footer-note" id="footer-text"></footer>
  </main>

  <!-- Post Listing Modal -->
  <div id="postModal" class="modal" aria-hidden="true" hidden>
    <div class="modal-box">
      <h3>Post a Listing</h3>
      <form id="postForm">
        <label>Farm name<input id="pfFarm" required></label>
        <label>Product<input id="pfProduct" required></label>
        <label>Quantity<input id="pfQty" placeholder="e.g., 40 kg / 100 lb" required></label>
        <label>Price<input id="pfPrice" placeholder="e.g., 2.50" required></label>
        <label>Mode
          <select id="pfMode"><option value="sale">Sale</option><option value="trade">Trade</option><option value="both">Both</option></select>
        </label>
        <div class="flex" style="margin-top:8px;">
          <button type="submit" class="btn">Post</button>
          <button type="button" class="btn secondary" id="postCancel">Cancel</button>
        </div>
        <div id="postErrors" class="muted" style="margin-top:8px"></div>
      </form>
    </div>
  </div>

  <!-- Error overlay -->
  <div id="hq-error" role="dialog" aria-live="assertive" hidden>
    <div class="box"><h4>Something went wrong</h4><pre id="hq-error-text"></pre><button class="btn" onclick="document.getElementById('hq-error').hidden=true">Close</button></div>
  </div>

  <script src="./js/app.js" defer></script>
</body>
</html>

<!-- index.html -->
<div id="postModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="postTitle" hidden>
  <div class="modal-box">
    <h3 id="postTitle">Post a Listing</h3>
    <!-- form unchanged -->
  </div>
</div>

// js/app.js (near modal wiring)
let postOpenerBtn = null;

function trapFocus(modal){
  const selectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
  const focusables = Array.from(modal.querySelectorAll(selectors)).filter(el=>!el.disabled);
  if(!focusables.length) return;
  let first = focusables[0], last = focusables[focusables.length-1];
  function onKey(e){
    if(e.key==='Tab'){
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
    if(e.key==='Escape'){ closePostModal(); }
  }
  modal.addEventListener('keydown', onKey);
  modal._focusTrapCleanup = () => modal.removeEventListener('keydown', onKey);
  first.focus();
}

function openPostModal(btn){
  postOpenerBtn = btn || null;
  els.postModal.hidden = false;
  els.postModal.setAttribute('aria-hidden','false');
  trapFocus(els.postModal);
  els.pfFarm?.focus();
}

function closePostModal(){
  els.postModal.hidden = true;
  els.postModal.setAttribute('aria-hidden','true');
  els.postModal._focusTrapCleanup?.();
  postOpenerBtn?.focus();
}

els.postOpenBtn?.addEventListener('click', ()=>openPostModal(els.postOpenBtn));
E('postCancel')?.addEventListener('click', closePostModal);
