<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Harvest Q – Stage 2 (Beta)</title>
  <meta name="description" content="Harvest Q – Markets, map, and AI price suggestions (Stage 2)" />

  <!-- PWA & icons (relative paths for GH Pages / Vercel) -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0f766e" />
  <link rel="icon" href="./logo.png" />
  <link rel="apple-touch-icon" href="./logo.png" />

  <link rel="stylesheet" href="./css/style.css" />

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // register relative service worker so it works on GitHub Pages subpaths
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>
</head>
<body>
  <!-- Compare banner -->
  <div class="compare-banner">
    <strong>Compare:</strong>
    <!-- Stage 1 is live on Vercel per your note -->
    <a id="cmp-stage1" href="https://harvest-q.vercel.app/">Stage 1</a> |
    <!-- Point this to your Stage-2 Vercel URL once deployed; for now it links to this page -->
    <a id="cmp-stage2" href=".">Stage 2</a>
  </div>

  <header class="hq-header">
    <div class="container">
      <div class="brand">
        <img src="./logo.png" alt="Harvest Q logo" onerror="this.style.display='none'">
        <div>
          <h1>Harvest Q <span class="beta">BETA</span></h1>
          <p id="header-sub"></p>
        </div>
      </div>
      <div class="lang-area">
        <label for="langSelect" class="muted">Language</label>
        <select id="langSelect">
          <option value="en">English</option>
          <option value="hi">हिन्दी (Hindi)</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <nav id="tabs" class="tabs" role="tablist" aria-label="Main sections"></nav>

    <section id="panel-home" role="tabpanel" hidden>
      <div class="grid two-col">
        <div>
          <div class="card">
            <h3 id="home-what-title"></h3>
            <p id="home-what-content"></p>
          </div>
          <div class="card">
            <h3>Values</h3>
            <p id="home-phil-content"></p>
            <div class="blockquote" id="home-phil-quote"></div>
          </div>
        </div>
        <div>
          <div class="card">
            <h3>Quick Filters</h3>
            <div class="toolbar">
              <label>Country
                <select id="countrySelect"></select>
              </label>
              <label>State/Region
                <select id="stateSelect"></select>
              </label>
              <label id="cityLabel">City
                <select id="citySelect"><option value="">All Cities</option></select>
              </label>
              <button class="btn" id="refreshBtn">Refresh</button>
            </div>
            <p class="footer-note" id="home-switch-note"></p>
          </div>
          <div class="card warning" id="home-warning"></div>
        </div>
      </div>
    </section>

    <section id="panel-farmers" role="tabpanel" hidden>
      <div class="toolbar">
        <input id="farmerSearch" placeholder="" />
        <select id="modeFilter">
          <option value="all"></option>
          <option value="sale"></option>
          <option value="trade"></option>
          <option value="both"></option>
        </select>
        <select id="sortBy">
          <option value="name"></option>
          <option value="priceAsc"></option>
        </select>
        <button class="btn" id="postOpenBtn">Post a Listing</button>
      </div>
      <div id="farmerGrid" class="grid"></div>
      <div id="mapArea" class="card" style="margin-top:12px">
        <h4>Market Map</h4>
        <div id="map" style="height:360px;border-radius:8px;"></div>
        <div id="map-legend" class="legend"></div>
      </div>
    </section>

    <section id="panel-consumers" role="tabpanel" hidden>
      <div class="toolbar"><input id="consumerSearch" placeholder="" /></div>
      <div id="consumerGrid" class="grid"></div>
    </section>

    <section id="panel-laws" role="tabpanel" hidden>
      <div id="lawGrid" class="grid"></div>
      <p class="muted" id="laws-disclaimer"></p>
    </section>

    <!-- NEW: Medical panel for parity with Stage 1 -->
    <section id="panel-medical" role="tabpanel" hidden>
      <div id="medGrid" class="grid"></div>
    </section>

    <!-- NEW: Trade panel for parity with Stage 1 -->
    <section id="panel-trade" role="tabpanel" hidden>
      <p class="muted" id="trade-disclaimer"></p>
    </section>

    <section id="panel-ai" role="tabpanel" hidden>
      <div class="card">
        <h3 id="ai-price-title"></h3>
        <div class="toolbar">
          <input id="aiCrop" list="cropList" placeholder="" />
          <!-- datalist was missing -->
          <datalist id="cropList"></datalist>
          <input id="aiQty" placeholder="" />
          <button class="btn" id="aiPriceBtn"><span id="ai-price-btn-text"></span></button>
        </div>
        <pre id="aiPriceOut"></pre>
      </div>

      <div class="card">
        <h3 id="ai-match-title"></h3>
        <div class="toolbar">
          <input id="aiWant" placeholder="" />
          <button class="btn" id="aiMatchBtn"><span id="ai-match-btn-text"></span></button>
        </div>
        <pre id="aiMatchOut"></pre>
      </div>
    </section>

    <footer class="footer-note" id="footer-text"></footer>
  </main>

  <!-- Post Listing Modal (a11y tightened) -->
  <div id="postModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="postTitle" aria-hidden="true" hidden>
    <div class="modal-box">
      <h3 id="postTitle">Post a Listing</h3>
      <form id="postForm">
        <label>Farm name<input id="pfFarm" required></label>
        <label>Product<input id="pfProduct" required></label>

        <!-- Inline field errors & numeric constraints -->
        <label>Quantity
          <input id="pfQty" inputmode="decimal" step="0.01" min="0.01" placeholder="e.g., 40 kg / 100 lb" required>
          <span class="field-error" id="errQty" aria-live="polite"></span>
        </label>
        <label>Price
          <input id="pfPrice" inputmode="decimal" step="0.01" min="0.01" placeholder="e.g., 2.50" required>
          <span class="field-error" id="errPrice" aria-live="polite"></span>
        </label>

        <label>Mode
          <select id="pfMode">
            <option value="sale">Sale</option>
            <option value="trade">Trade</option>
            <option value="both">Both</option>
          </select>
        </label>

        <div class="flex" style="margin-top:8px;">
          <button type="submit" class="btn">Post</button>
          <button type="button" class="btn secondary" id="postCancel">Cancel</button>
        </div>

        <!-- keep general box for non-field errors -->
        <div id="postErrors" class="muted" style="margin-top:8px"></div>
      </form>
    </div>
  </div>

  <!-- Error overlay -->
  <div id="hq-error" role="dialog" aria-live="assertive" hidden>
    <div class="box">
      <h4>Something went wrong</h4>
      <pre id="hq-error-text"></pre>
      <button class="btn" onclick="document.getElementById('hq-error').hidden=true">Close</button>
    </div>
  </div>

  <script src="./js/app.js" defer></script>
</body>
</html>

<section id="panel-grants" role="tabpanel" hidden>
  <div class="card">
    <h3 id="grants-title">Harvest Grant Program</h3>
    <p id="grants-sub" class="muted">
      We’re preparing to offer $500 micro-grants to farmers, consumers, and organizations
      helping feed the homeless, elderly, and those in need.
    </p>

    <div class="notice">
      <span class="badge">Coming Soon</span>
      <strong>$500 Harvest Grant</strong> applications will open once eligibility
      and partners are finalized.
    </div>

    <h4 style="margin-top:10px">Who can apply?</h4>
    <ul class="muted">
      <li>Farmers – smallholders, co-op growers, or urban farmers</li>
      <li>Consumers – individuals or families promoting local produce</li>
      <li>Organizations – pantries, shelters, or food-aid networks</li>
    </ul>

    <div class="flex" style="gap:8px;margin-top:10px">
      <a class="btn" href="mailto:grants@harvestq.org?subject=Harvest%20Grant%20Notification">
        Get Notified
      </a>
      <a class="btn secondary" href="#" target="_blank" rel="noopener">Program FAQ (soon)</a>
    </div>

    <p class="footer-note" style="margin-top:10px">
      Applications expected next stage. This announcement does not guarantee award or eligibility.
    </p>
  </div>
</section>

<button class="ai-suggest-farmers" 
        data-crop="Tomatoes" 
        data-minqty="200 kg" 
        data-location="Kano">AI: Suggest Farmers</button>

<div class="ai-result" aria-live="polite"></div>
